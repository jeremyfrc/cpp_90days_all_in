# çœŸå®å¼•æ“æ¶æ„æ€æƒ³çš„æœ€å°å®ç°

## é—®é¢˜æ¨¡å‹ï¼ˆçœŸå®å¼•æ“çº¦æŸï¼‰

| çº¿ç¨‹   | è¡Œä¸º     |
| ---- | ------ |
| é€»è¾‘çº¿ç¨‹ | æ›´æ–°å®ä½“ä½ç½® |
| æ¸²æŸ“çº¿ç¨‹ | è¯»å–å®ä½“ä½ç½® |

### è¦æ±‚ï¼š
- è¯»å†™å¿…é¡»å¹¶è¡Œ
- æ¸²æŸ“ä¸èƒ½è¢«é”é˜»å¡
- æ•°æ®å¿…é¡»ä¸€è‡´ï¼ˆä¸èƒ½è¯»åˆ°ä¸€åŠæ›´æ–°ï¼‰
- å»¶è¿Ÿ < 0.1ms
### ğŸ‘‰ ç»“è®ºï¼š
- ä¸èƒ½é”ï¼Œåªèƒ½å¿«ç…§

## æ ¸å¿ƒæ¶æ„ï¼šåŒç¼“å†² ECS å­˜å‚¨

### æ€æƒ³ï¼š
```
front_buffer  â†’ æ¸²æŸ“çº¿ç¨‹è¯»
back_buffer   â†’ é€»è¾‘çº¿ç¨‹å†™

frame end:
swap(front, back)
```
æ¸²æŸ“æ°¸è¿œè¯»ç¨³å®šæ•°æ®
é€»è¾‘æ°¸è¿œå†™ç‹¬å æ•°æ®
æ— é” âœ”
æ— ç«äº‰ âœ”
ä¸€è‡´æ€§ âœ”

## æ•°æ®å¸ƒå±€ï¼ˆå…³é”®å·¥ç¨‹ç‚¹ï¼‰

### ä¸ç”¨ AoSï¼š
```
struct Entity { float x,y,z; }
vector<Entity>
```
åŸå› ï¼šcache miss å¤š

### æ”¹ä¸º SoAï¼š
```
vector<float> pos_x;
vector<float> pos_y;
vector<float> pos_z;
```

### ä¼˜åŠ¿ï¼š
- SIMD å‹å¥½
- cache line å‘½ä¸­ç‡é«˜
- æ‰¹å¤„ç†å¿«

## æœ€å°å®ç°ç‰ˆæœ¬

æ•°æ®å±‚
```cpp
struct PositionBuffer {
    std::vector<float> x, y, z;

    void resize(size_t n) {
        x.resize(n);
        y.resize(n);
        z.resize(n);
    }
};
```

åŒç¼“å†²å®¹å™¨ï¼š
```cpp
class PositionStorage {
public:
    PositionStorage(size_t n) {
        buffers_[0].resize(n);
        buffers_[1].resize(n);
    }

    PositionBuffer& write() noexcept {
        return buffers_[write_index_];
    }

    const PositionBuffer& read() const noexcept {
        return buffers_[read_index_];
    }

    void commit() noexcept {
        std::swap(read_index_, write_index_);
    }

private:
    PositionBuffer buffers_[2];
    int read_index_  = 0;
    int write_index_ = 1;
};
```

ç‰¹ç‚¹ï¼š
- æ— é”
- æ— åŸå­
- æ— shared_ptr
- æ— mutex
- è¯»å†™ä»ä¸è®¿é—®åŒä¸€å—å†…å­˜

## çº¿ç¨‹ä½¿ç”¨æ–¹å¼

é€»è¾‘çº¿ç¨‹
```cpp
auto& buf = storage.write();
for (size_t i = 0; i < N; ++i)
    buf.x[i] += 1.0f;

storage.commit();
```

æ¸²æŸ“çº¿ç¨‹
```cpp
auto const& buf = storage.read();
draw(buf.x, buf.y, buf.z);
```

## æ€è€ƒé¢˜

### å¦‚æœé€»è¾‘çº¿ç¨‹æ›´æ–°è¿‡ç¨‹ä¸­å´©æºƒï¼Œä¼šä¸ä¼šå½±å“æ¸²æŸ“ï¼Ÿ
ä¸ä¼šå½±å“æ¸²æŸ“ï¼Œåªè¦é€»è¾‘çº¿ç¨‹åœ¨ commit ä¹‹å‰å´©æºƒï¼Œæ¸²æŸ“å°±å®Œå…¨ä¸å—å½±å“ã€‚
åŒç¼“å†²å¤©ç„¶å…·å¤‡å´©æºƒéš”ç¦»èƒ½åŠ›ã€‚

### å¦‚æœ commit æ—¶æ¸²æŸ“æ­£åœ¨è¯»ï¼Œä¼šä¸ä¼šæ’•è£‚ï¼Ÿ
index swap å¿…é¡»æ˜¯åŸå­çš„ï¼Œå¦åˆ™ä¼šå‡ºç°ã€‚
std::atomic<int> read_index_;

### ä»€ä¹ˆæ—¶å€™åŒç¼“å†²ä¸å¤Ÿï¼Œéœ€è¦ä¸‰ç¼“å†²ï¼Ÿ
ä¸‰ç¼“å†²è§£å†³çš„æ˜¯å†™é€Ÿåº¦>è¯»é€Ÿåº¦ï¼Œå†™çº¿ç¨‹å¯èƒ½ä¼šè¿½ä¸Šè¯»çº¿ç¨‹
readï¼Œreadyï¼Œwrite
ä¸‰ç¼“å†²ç”¨äºè§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é€Ÿåº¦ä¸åŒ¹é…é—®é¢˜

### å¦‚æœå®ä½“æ•°é‡æ¯å¸§å˜åŒ–æ€ä¹ˆåŠï¼Ÿ
é¢„åˆ†é…å®¹é‡ + åŠ¨æ€ size

### è¿›é˜¶é¢˜
å‡è®¾ï¼š
- å®ä½“æ•°é‡ = 1,000,000
- æ¯å¸§æ›´æ–° 10,000 ä¸ªå®ä½“
- æ¸²æŸ“éœ€è¦å…¨éƒ¨å®ä½“
- ä½ è¿˜ä¼šç”¨æ•´ä¸ª buffer swap å—ï¼Ÿ
è¿˜æ˜¯ï¼š
- Aï¼‰ä»ç„¶ swap å…¨é‡ [cache å†™æ”¾å¤§ + å†…å­˜å¸¦å®½ç‰ºç‰²]
- Bï¼‰åªæ›´æ–° dirty åŒºåŸŸ
- Cï¼‰åˆ†å—ç¼“å†²
- Dï¼‰æ”¹æˆ RCU
é€‰äº†C

### è§£ç­”ï¼š
å·¥ç¨‹äº‹å®ä¼˜å…ˆçº§æ’åºï¼š
dirty list > block buffer > full swap
æœ€ä½³æ–¹æ¡ˆæ˜¯ï¼šDirty List + SoA + å•ç¼“å†² + å¸§è¾¹ç•Œåº”ç”¨
```
front buffer â†’ æ¸²æŸ“
back buffer â†’ åŒä¸€å—
dirty list â†’ è®°å½•å˜åŒ–
```
å…ˆæµ‹é‡çº¦æŸå†é€‰æ–¹æ¡ˆï¼š
å†™å¯†åº¦ = ?
å†™åˆ†å¸ƒ = ?
å†™è¿ç»­æ€§ = ?
è¿™ä¸‰ä¸ªå†³å®šæ¶æ„ã€‚

### å‡çº§é¢˜
å‡è®¾ç°åœ¨ï¼š
å®ä½“ = 1,000,000
æ›´æ–° = 10,000
ä½†è¿™ 10,000 æ¯å¸§éƒ½ä¸åŒ
è€Œä¸”åˆ†å¸ƒéšæœº

ä½ è¿˜ä¼šç”¨ dirty list å—ï¼Ÿ
è¿˜æ˜¯æ”¹æ¶æ„ï¼Ÿ
ä¸ºä»€ä¹ˆï¼Ÿ

### è§£ç­”ï¼š
è¿˜å¯ä»¥ç»§ç»­ç”¨dirty list,ä½†æ˜¯å–å†³äºå†™å¯†åº¦ï¼Œè€Œä¸å–å†³äºå†™åˆ†å¸ƒ
dirty ratio > 30% dirty listä¼šå¤±æ•ˆ
<10% dirty listæœ€ä¼˜æ–¹æ¡ˆ
10%-40% åˆ†å—
40%+ å…¨é‡Swap

MVCCï¼Œ WALï¼Œsnapshot isolationè¿™äº›å’Œè¿™é‡Œå¤„ç†çš„åœºæ™¯å¼‚æ›²åŒå·¥

### æ¶æ„é¢˜è¿›é˜¶
å®ä½“ = 1,000,000
æ›´æ–° = 200,000
åˆ†å¸ƒ = éšæœº
å¸§é¢„ç®— = 2ms
é—®é¢˜ï¼š

ä½ è¿˜ä¼šåšæŒ dirty list å—ï¼Ÿè¿˜æ˜¯åˆ‡æ¶æ„ï¼Ÿ

è¯·å›ç­”ï¼š

Aï¼‰ç»§ç»­ dirty list
Bï¼‰æ”¹ä¸ºåˆ†å—å¤åˆ¶
Cï¼‰ç›´æ¥æ•´å— swap
Dï¼‰è®¾è®¡è‡ªé€‚åº”ç­–ç•¥

å¹¶è¯´æ˜ç†ç”±ã€‚

### è§£ç­”
æœ€ä¼˜ç­”æ¡ˆç¡®å®æ˜¯ Dï¼ˆè‡ªé€‚åº”ç­–ç•¥ï¼‰
ç†ç”±åº”è¯¥æ˜¯ï¼š
å¸¦å®½ä¸»å¯¼ï¼Œè€Œä¸æ˜¯æ¯”ä¾‹ä¸»å¯¼

```
çœŸå®å·¥ç¨‹æ¨ç†é¡ºåºåº”è¯¥æ˜¯ï¼š
1. å¸§é¢„ç®—å¤šå°‘ï¼Ÿ
2. æ¯å¸§å¯å†™å­—èŠ‚å¤šå°‘ï¼Ÿ
3. æ–¹æ¡ˆå¸¦å®½æ˜¯å¤šå°‘ï¼Ÿ
4. å“ªä¸ªä¸çˆ†å¸¦å®½ï¼Ÿ
```

å·¥ä¸šå®ç°é€šå¸¸æ˜¯ï¼š
if dirty_bytes < threshold[measured bandwidth budget]
    apply dirty
else
    memcpy full

å¼•æ“æœ¬èº«å°±æ˜¯ä¸€ä¸ªç­–ç•¥è°ƒåº¦å™¨ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå›ºå®šç®—æ³•ã€‚

| é€‰é¡¹ | çœŸæ­£å«ä¹‰        | æœ¬è´¨ç­–ç•¥       |
| -- | ----------- | ---------- |
| A  | åˆ†å—ç¼“å†²        | åˆ†åŒºé” / åˆ†åŒºæäº¤ |
| B  | Full swap   | æ•´ä½“åŒç¼“å†²      |
| C  | SoA + dirty | å±€éƒ¨æ›´æ–°       |
| D  | RCU         | ç‰ˆæœ¬æŒ‡é’ˆåˆ‡æ¢     |


Dirtyæˆæœ¬ â‰ˆ dirty_ratio Ã— randomness Ã— cache_line_cost
FullSwapæˆæœ¬ â‰ˆ å…¨é‡ memcpy

å®é™…æˆæœ¬ â‰ˆ dirty_bytes_cost + cache_miss_penalty + write_amplification
å®é™…å¸¦å®½ â‰ˆ dirty_bytes Ã— cache_line_size

5% dirty, éšæœºå†™
full swap å†™100%
è¿™é‡Œæœ‰20å€çš„å†™æ”¾å¤§

è®¿é—®æ¨¡å¼æƒé‡ > dirtyæ¯”ä¾‹ > æ•°æ®ç»“æ„

å…³äºAoSå’ŒSoA
| åœºæ™¯           | æ¨èå¸ƒå±€ |
| ------------ | ---- |
| SIMD / æ‰¹å¤„ç†   | SoA  |
| é¡ºåºæ›´æ–°         | SoA  |
| éšæœºæ›´æ–°         | AoS  |
| é¢‘ç¹æ”¹å•ä¸ªå¯¹è±¡      | AoS  |
| åªè¯»è®¡ç®—         | SoA  |
| ç‰©ç†æ¨¡æ‹Ÿ         | SoA  |
| æ¸¸æˆ entity æ›´æ–° | AoS  |

SoA ä¼˜åŒ–çš„æ˜¯è®¡ç®—åå é€‚åˆæ‰¹é‡å¤„ç†å­—æ®µ
AoS ä¼˜åŒ–çš„æ˜¯è®¿é—®å»¶è¿Ÿ é€‚åˆæ”¹å•ä¸ªå¯¹è±¡
ç“¶é¢ˆæ˜¯ latency è¿˜æ˜¯ throughputï¼Ÿ

æ›´æ–°ä¸€ä¸ª entity å®é™…æˆæœ¬: æ›´æ–°ä¸€ä¸ª entity å®é™…æˆæœ¬

## å¸ƒå±€å›é¡¾
### AoS
```cpp
struct Entity {
    float x,y,z;
    int hp;
};
Entity arr[N];
```
#### å†…å­˜ï¼š
```
[x y z hp][x y z hp][x y z hp]
```
### SoA
```cpp
struct World {
    float x[N];
    float y[N];
    float z[N];
    int hp[N];
};
```
#### å†…å­˜ï¼š
```
[x x x x x]
[y y y y y]
[z z z z z]
[hp hp hp]
```

```mathematica
dirty list å®é™…æˆæœ¬
19.2N / 0.25 â‰ˆ 76.8N
full swap å®é™…æˆæœ¬
64N / 0.9 â‰ˆ 71N
```

### åˆ¤è¯»è§„åˆ™
dirty_ratio < 0.15 â†’ å¢é‡æ›´æ–°
dirty_ratio > 0.40 â†’ å…¨é‡æ›´æ–°
ä¸­é—´åŒºé—´ â†’ çœ‹éšæœºåº¦

æŠŠå½“å‰ç³»ç»Ÿæµ‹å¾—çš„å‚æ•°ä»£å…¥ï¼š
xè½´ = dirty_ratioï¼ˆå†™æ¯”ä¾‹ï¼‰
yè½´ = éšæœºåº¦ï¼ˆè®¿é—®ç¦»æ•£ç¨‹åº¦ï¼‰
ğŸ“Œ è½åœ¨æ›²çº¿ä¸‹æ–¹ â†’ ç”¨ Dirty List
è¯´æ˜å†™æ¯”ä¾‹ä½ æˆ– å†™è¾ƒé›†ä¸­
â†’ å¢é‡æ›´æ–°æˆæœ¬ä½
ğŸ“Œ è½åœ¨æ›²çº¿ä¸Šæ–¹ â†’ ç”¨ Full Swap
è¯´æ˜å†™æ¯”ä¾‹é«˜ æˆ– å†™æéšæœº
â†’ æ‰¹é‡ memcpy æ›´åˆ’ç®—

![å†³ç­–è¾¹ç•Œå›¾](https://github.com/jeremyfrc/cpp_90days_all_in/tree/master/day22/image1.png)


### æœ€åä¸€é¢˜

ä¸€ä¸ªç³»ç»Ÿ dirty_ratio=12%ï¼Œéšæœºåº¦=0.8ï¼Œä½† cache line å‘½ä¸­ç‡åªæœ‰30%ï¼Œé€‰ä»€ä¹ˆç­–ç•¥ï¼Ÿ

æ ¹æ®å†³ç­–è¾¹ç•Œå›¾ï¼Œåº”è¯¥é€‰dirty list
*å·¥ç¨‹ç›´è§‰æ€»ç»“*
- Dirty list ä¼˜åŠ¿ï¼šå°‘é‡å†™æ“ä½œ â†’ èŠ‚çœå†…å­˜å¸¦å®½
- Full swap åŠ£åŠ¿ï¼šæ‹·è´å…¨é‡ â†’ å¸¦å®½æµªè´¹ï¼Œå°¤å…¶å†™æ¯”ä¾‹ä½æ—¶
- éšæœºæ€§è™½ç„¶å½±å“ cacheï¼Œä½† 12% çš„å†™æ¯”ä¾‹ä»å°äºé˜ˆå€¼ (~25%) â†’ ä¸éœ€è¦ full swap
